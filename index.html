<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta id="themeColorMeta" name="theme-color" content="#f6f8fb" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="icon" href="./icons/icon-192.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="./icons/icon-192.png" />
    <title>Toodoom</title>
    <style>
        :root {
            --bg: #f6f8fb;
            --card-radius: 22px;
            --shadow: 0 8px 24px rgba(0, 0, 0, .12);
            --shadow-soft: 0 2px 10px rgba(0, 0, 0, .06);
            --text: #1f2a36;
            --card-text: #1f2a36;
            --muted: #5a6876;
            --card-muted: #5a6876;
        }

        /* Prevent iOS Safari auto-inverting form controls; align UA widgets */
        :root { color-scheme: light; }
        :root[data-theme="dark"] { color-scheme: dark; }

        /* Dark theme overrides */
        [data-theme="dark"] {
            --bg: #0f1216;
            --text: #e8eef6;
            --card-text: #1f2a36;
            --muted: #9aa7b4;
            --card-muted: #5a6876;
            --shadow: 0 8px 24px rgba(0, 0, 0, .12);
            --shadow-soft: 0 2px 10px rgba(0, 0, 0, .06);
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        html {
            scroll-behavior: smooth
        }

        body {
            margin: 0;
            font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial;
            color: var(--text);
            background: var(--bg);
            display: grid;
            place-items: start center;
            padding: 16px 0px 96px
        }

        .app {
            width: min(880px, 100%)
        }

        header {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
            padding-left: 16px;
            padding-right: 16px;
        }

        header .top {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: space-between;
        }

        .lists {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .list-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background: #fff;
            border: 1px solid #e5e9ef;
            border-radius: 12px;
            padding: 8px 12px;
            box-shadow: var(--shadow-soft);
            font: inherit;
            color: var(--text);
            cursor: pointer;
        }

        .list-add {
            border: 1px solid #e5e9ef;
            background: #fff;
            border-radius: 10px;
            width: 32px;
            height: 32px;
            display: grid;
            place-items: center;
            cursor: pointer;
            box-shadow: var(--shadow-soft);
        }

        /* Hide list selector controls now that categories are primary */
        .list-select, .list-add { display: none; }

        header h1 {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: .2px;
            margin: 0
        }

        .chips {
            display: grid;
            gap: 6px
        }

        /* Chip rows are single-line and scroll horizontally */
        .chips .row { white-space: nowrap; }

        /* Hide scrollbars (keep scrolling) */
        .row, .list {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE 10+ */
        }
        .row::-webkit-scrollbar, .list::-webkit-scrollbar { display: none; } /* WebKit */

        .row {
            display: flex;
            flex-wrap: nowrap;
            gap: 6px;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: #fff;
            border: 1px solid #e5e9ef;
            box-shadow: var(--shadow-soft);
            font-size: 13px;
            cursor: pointer;
            user-select: none;
            flex: 0 0 auto;
        }

        [data-theme="dark"] .chip { background: #151a21; border-color: #2a3340; }

        .chip .del {
            display: inline-grid;
            place-items: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            color: var(--muted);
            cursor: pointer;
            opacity: 1 !important;
        }
        /* Always visible delete control */
        /* transition not needed when always visible */

        .chip .x {
            font-weight: 700
        }

        .chip.active {
            border-color: #c7d1e0
        }

        .quick {
            display: flex;
            gap: 10px;
            width: 100%;
            background: #fff;
            padding: 10px;
            border-radius: 14px;
            box-shadow: var(--shadow-soft);
            align-items: center
        }

        .quick input {
            flex: 1;
            border: 0;
            outline: 0;
            font: inherit;
            padding: 12px 14px;
            border-radius: 10px;
            background: #f1f4f8
        }

        /* Improve iOS Safari dark mode readability for quick add */
        [data-theme="dark"] .quick { background: #151a21; }
        [data-theme="dark"] .quick input { background: #10151c; color: var(--card-text);; -webkit-text-fill-color: var(--card-text); }
        [data-theme="dark"] .quick input::placeholder { color: var(--card-text);; }

        /* Ensure dark text color in iOS Safari for all form fields */
        :root[data-theme="dark"] input,
        :root[data-theme="dark"] textarea,
        :root[data-theme="dark"] select { color: var(--card-text); -webkit-text-fill-color: var(--card-text); }

        .quick button {
            border: 0;
            padding: 12px 16px;
            border-radius: 12px;
            background: var(--text);
            color: #fff;
            cursor: pointer;
            font-weight: 600
        }

        .list {
            display: grid;
            gap: 0;
            padding-left: 16px;
            padding-top: 16px;
            padding-bottom: 25px;
            padding-right: 16px;
            max-height: calc(100vh - 153px);
            overflow-y: auto;
        }

        /* Notes grid layout */
        .list.notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            align-content: start;
            padding-bottom: 8px;
            padding-top: 16px
        }

        .card {
            position: relative;
            overflow: hidden;
            border-radius: var(--card-radius);
            color: var(--card-text);
            background: linear-gradient(120deg, var(--c1), var(--c2));
            box-shadow: var(--shadow);
            isolation: isolate;
            cursor: pointer
        }

        /* Dark mode: keep gradients but improve text readability with subtle overlay */
        [data-theme="dark"] .card::after {
            /*content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), inset 0 -36px 60px rgba(0,0,0,.22);
            background: rgba(0,0,0,.28);*/
        }

        /* Dark mode: increase contrast/readability on cards */
        [data-theme="dark"] .card {
            /*background: linear-gradient(135deg, var(--c1), var(--c2)), linear-gradient(0deg, rgba(0,0,0,.35), rgba(0,0,0,.35)) !important;
            background-blend-mode: overlay;
            border: 1px solid #2a3340; */
        }

        /* Target iOS Safari to slightly increase dark overlay for gradients */
        @supports (-webkit-touch-callout: none) {
            [data-theme="dark"] .card::after { background: rgba(0,0,0,.42); }
        }

        .card:not(:first-child) {
            margin-top: 10px
        }

        .rowx {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            align-items: start;
            padding: 22px
        }

        .title {
            font-size: 18px;
            font-weight: 400;
            margin: 0
        }

        /* Invert entire card in dark mode for readability */
        [data-theme="dark"] .card { filter: invert(1); }

        .card.done .title {
            text-decoration: line-through;
            opacity: .8;
        }

        .desc {
            margin: 0;
            color: var(--card-muted);
            max-width: 52ch;
            font-size: 16px;
            padding: 0 22px 22px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .card:not(:hover):not(.touch-active) .desc {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }

        .card:hover .desc,
        .card.touch-active .desc {
            max-height: 200px;
            padding-top: 0;
            padding-bottom: 22px;
            opacity: 1;
        }

        /* Show a subtle indicator when description is collapsed */
        .card:not(:hover) .desc:not(:empty)::before {
            content: "⋯";
            color: var(--card-muted);
            opacity: 0.6;
            font-size: 18px;
            line-height: 1;
        }

        .card:hover .desc::before {
            display: none;
        }

        /* Inline add card inputs */
        .title-input {
            font-size: 18px;
            font-weight: 400;
            margin: 0;
            border: 0;
            outline: 0;
            width: 100%;
            background: transparent;
            color: inherit;
        }

        /* Inputs on dark card */
        /*[data-theme="dark"] .card .title-input, [data-theme="dark"] .card .desc-input { color: #eef3f9; }
        [data-theme="dark"] .card .title-input::placeholder, [data-theme="dark"] .card .desc-input::placeholder { color: #cfd8e4; }
*/
        .desc-input {
            display: block;
            width: 100%;
            border: 0;
            outline: 0;
            background: transparent;
            color: var(--muted);
            font: inherit;
            font-size: 16px;
            padding: 0 22px 22px;
            resize: vertical;
            min-height: 44px;
        }

        .title-input::placeholder,
        .desc-input::placeholder {
            color: #8a95a3;
        }

        .tags {
            margin: 0;
            font-size: 14px;
            color: var(--muted);
            padding: 0 22px 22px
        }

        .tags span {
            margin-right: 6px;
            cursor: pointer
        }

        /* Strengthen text contrast inside cards on dark */
        /*[data-theme="dark"] .title { color: #eef3f9; }
        [data-theme="dark"] .desc { color: #aab6c4; }*/

        .check {
            min-width: 24px;
            min-height: 24px;
            display: grid;
            place-items: center;
            border-radius: 50%;
            /*border: 2px solid rgba(0, 0, 0, .2);*/
            background: rgba(255, 255, 255, .5);
            cursor: pointer
        }

        /*[data-theme="dark"] .card .check { border-color: rgba(255,255,255,.25); background: rgba(255,255,255,.12); color: #f3f7fb; }
        [data-theme="dark"] .check {
            border-color: #3a4554;
            background: rgba(255,255,255,.08);
            color: var(--text);
        }
        [data-theme="dark"] .card .check.done { background: rgba(0,0,0,.7); color: #fff; border-color: transparent; }

        [data-theme="dark"] .check.done {
            background: rgba(255,255,255,.22);
            color: #fff;
        } */

        /* Animations */
        @keyframes cardIn {
            from {
                opacity: 0;
                transform: translateY(12px) scale(.98)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        @keyframes pop {
            0% {
                transform: scale(1)
            }

            50% {
                transform: scale(.98)
            }

            100% {
                transform: scale(1)
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 0, 0, .18)
            }

            100% {
                box-shadow: 0 0 0 14px rgba(0, 0, 0, 0)
            }
        }

        .card {
            will-change: transform, opacity
        }

        .card.enter {
            animation: cardIn .35s cubic-bezier(.2, .8, .2, 1) both
        }

        .card.solving {
            animation: pop .22s ease
        }

        .check.pulse {
            animation: pulse .6s ease-out
        }

        .card.done {
            filter: grayscale(1) brightness(.8);
            opacity: .7;
        }

        [data-theme="dark"] .card.done {
            filter: grayscale(1) brightness(.4);
            opacity: .7;
        }

        /* Sticky note styles */
        .note-card {
            position: relative;
            border-radius: 12px;
            padding: 14px;
            background: #fffad1;
            box-shadow: var(--shadow);
            color: #1b2430;
            cursor: pointer;
            transition: transform .12s ease;
            display: flex;
            flex-direction: column;
            aspect-ratio: 1 / 1;
        }
        .note-card:hover { transform: translateY(-2px); }
        .note-card .text {
            margin: 0;
            white-space: pre-wrap;
            overflow: auto;
            max-height: 40vh;
            overflow-wrap: anywhere;
            word-break: break-word;
        }
        .note-card .tags { padding: 10px 0 0; font-size: 13px; color: #4b5563; }
        .note-card .tags span { color: inherit; }
        .note-card .del {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 22px;
            height: 22px;
            display: grid;
            place-items: center;
            border-radius: 50%;
            background: rgba(0,0,0,.06);
            color: currentColor;
        }
        /* Small add note card */
        .note-new { display: grid; gap: 8px; }
        .note-input {
            width: 100%;
            min-height: 60px;
            border: 0;
            outline: 0;
            border-radius: 10px;
            padding: 10px 12px;
            background: transparent;
            box-shadow: none;
            font: inherit;
            height: 100%;
            overflow: auto;
            color: inherit;
        }
        
        /* Dark mode for notes */
        [data-theme="dark"] .note-card { filter: invert(1); }

        /* Suggestions dropdown */
        .suggest {
            background: #fff;
            border: 1px solid #e5e9ef;
            box-shadow: var(--shadow-soft);
            border-radius: 12px;
            margin: 0 22px 14px;
            overflow: hidden;
        }

        /* Dark mode for suggestions dropdown */
        [data-theme="dark"] .suggest { background: #151a21; border-color: #2a3340; }
        [data-theme="dark"] .suggest .item { 
           color: #e8eef6;
        }
        [data-theme="dark"] .suggest .item.active { background: rgba(255,255,255,.06); }

        .suggest.hidden { display: none; }

        .suggest .item {
            padding: 10px 12px;
            font-size: 14px;
            cursor: pointer;
        }

        .suggest .item + .item { border-top: 1px solid #f0f3f7; }

        .suggest .item.active {
            background: #f6f8fb;
        }

        .account-btn {
            display: inline-grid;
            place-items: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid #e5e9ef;
            background: #fff;
            box-shadow: var(--shadow-soft);
            cursor: pointer;
            color: var(--text);
        }

        .account-btn:hover { filter: brightness(0.98); }

        [data-theme="dark"] .account-btn { background: #151a21; border-color: #2a3340; }

        .share-btn {
            display: inline-grid;
            place-items: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid #e5e9ef;
            background: #fff;
            box-shadow: var(--shadow-soft);
            cursor: pointer;
            color: var(--text);
            margin-right: 6px;
        }
        .share-btn:hover { filter: brightness(0.98); }

        [data-theme="dark"] .share-btn { background: #151a21; border-color: #2a3340; }

        .theme-btn { composes: account-btn; }

        /* Actions menu shares account menu styles */
        .account .menu .item.disabled { opacity: .5; pointer-events: none; }

        /* Invite modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.32);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .modal-backdrop.show { display: flex; }
        .modal {
            width: min(460px, 92vw);
            background: #fff;
            border-radius: 14px;
            border: 1px solid #e5e9ef;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .modal .mh { padding: 14px 16px; font-weight: 700; border-bottom: 1px solid #f0f3f7; }
        .modal .mc { padding: 16px; display: grid; gap: 12px; }
        .modal .mf { padding: 12px 16px; border-top: 1px solid #f0f3f7; display: flex; gap: 8px; justify-content: flex-end; }
        .modal input, .modal textarea {
            width: 100%;
            border: 1px solid #e5e9ef;
            border-radius: 10px;
            padding: 10px 12px;
            background: #fff;
            font: inherit;
        }
        .modal input::placeholder, .modal textarea::placeholder { color: #8a95a3; }
        .btn {
            border: 1px solid #e5e9ef;
            border-radius: 10px;
            padding: 8px 12px;
            background: #fff;
            cursor: pointer;
        }
        .btn.primary { background: var(--text); color: #fff; border-color: transparent; }
        
        .err { color: #b42318; font-size: 13px; display:none; }

        /* Dark mode for modal */
        [data-theme="dark"] .modal { background: #151a21; border-color: #2a3340; color: #e8eef6; box-shadow: 0 20px 40px rgba(0,0,0,.6); }
        [data-theme="dark"] .modal .mh { border-bottom-color: #263042; }
        [data-theme="dark"] .modal .mf { border-top-color: #263042; }
        [data-theme="dark"] .modal input, [data-theme="dark"] .modal textarea {
            background: #10151c;
            border-color: #2a3340;
            color: #e8eef6;
        }
        [data-theme="dark"] .modal input::placeholder, [data-theme="dark"] .modal textarea::placeholder { color: #a2afbd; }
        [data-theme="dark"] .btn { background: #151a21; border-color: #2a3340; color: #e8eef6; }
        [data-theme="dark"] .btn.primary { background: #3a78ff; color: #fff; border-color: transparent; }

        .account { position: relative; }
        .account .menu {
            position: absolute;
            top: 44px;
            right: 0;
            background: #fff;
            border: 1px solid #e5e9ef;
            box-shadow: var(--shadow);
            border-radius: 12px;
            min-width: 240px;
            padding: 6px;
            z-index: 9999;
        }
        .account .menu.hidden { display: none; }
        .account .menu .item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text);
            white-space: nowrap;
        }
        .account .menu .item:hover { background: #f6f8fb; }
        .account .menu .divider { height: 1px; background: #f0f3f7; margin: 6px 0; }

        /* Dark mode for popover menus */
        [data-theme="dark"] .account .menu {
            background: #151a21 !important;
            border-color: #2a3340 !important;
            box-shadow: 0 10px 28px rgba(0,0,0,.6) !important;
        }
        [data-theme="dark"] .account .menu .item { color: #ffffff; }
        [data-theme="dark"] .account .menu .item:hover { background: rgba(255,255,255,.06); }
        [data-theme="dark"] .account .menu .divider { background: #263042; }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div class="top">
                <div class="lists">
                    <h1>Tasks</h1>
                    <select id="listSelect" class="list-select" aria-label="Select list"></select>
                    <button id="listAdd" class="list-add" title="Create list" aria-label="Create list">+</button>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <button class="account-btn" id="modeBtn" title="Toggle Tasks/Notes" aria-label="Toggle mode">
                        <svg id="modeIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    </button>
                    <div class="account" style="position:relative;">
                        <button class="account-btn" id="actionsBtn" title="Actions" aria-label="Actions" aria-expanded="false" aria-haspopup="menu">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                        </button>
                        <div class="menu hidden" id="actionsMenu" role="menu" aria-labelledby="actionsBtn" style="position:absolute; right:0; top:44px; background:#fff; border:1px solid #e5e9ef; box-shadow:0 4px 12px rgba(0,0,0,.15); border-radius:8px; min-width:180px; z-index:9999;">
                            <div class="item" role="menuitem" id="actCompleteAll" style="padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>
                                <span>Complete all</span>
                            </div>
                            <div class="item" role="menuitem" id="actDeleteCompleted" style="padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                                <span>Delete completed</span>
                            </div>
                        </div>
                    </div>
                    <button class="share-btn" id="shareBtn" title="Share category" aria-label="Share category">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                    </button>
                        <button class="account-btn" id="themeBtn" title="Toggle theme" aria-label="Toggle theme">
                        <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    </button>
                    <div class="account">
                        <span id="username"></span>
                        <button class="account-btn" id="accountBtn" title="Account" aria-label="Account" aria-expanded="false" aria-haspopup="menu">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21a8 8 0 0 0-16 0"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </button>
                        <div class="menu hidden" id="accountMenu" role="menu" aria-labelledby="accountBtn">
                            <div class="item" role="menuitem" id="menuRegister">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M6 12h12"/></svg>
                                <span>Register</span>
                            </div>
                            <div class="item" role="menuitem" id="menuLogin">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                                <span>Login</span>
                            </div>
                            <div class="item" role="menuitem" id="menuSignOut">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                <span>Sign out</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chips">
                <div class="row" id="catsRow"></div>
                <div class="row" id="tagsRow"></div>
            </div>
        </header>

        

        <div class="list" id="list"></div>
    </div>

    <!-- Invite Modal -->
    <div class="modal-backdrop" id="registerBackdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="registerTitle">
            <div class="mh" id="registerTitle">Register</div>
            <div class="mc">
                <label>Email</label>
                <input type="email" id="registerEmail" placeholder="you@example.com" />
                <label>Password</label>
                <input type="password" id="registerPassword" placeholder="Enter password" />
                <label>Confirm Password</label>
                <input type="password" id="registerPasswordConfirm" placeholder="Confirm password" />
                <button class="btn primary" id="registerSubmit">Register</button>
                <!--<hr/>
                <button class="btn primary" id="registerGithub">Register with GitHub</button>
                <button class="btn primary" id="registerGoogle">Register with Google</button>
                <button class="btn primary" id="registerMicrosoft">Register with Microsoft</button>-->
            </div>
            <div class="mf">
                <button class="btn" id="registerCancel">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="loginBackdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
            <div class="mh" id="loginTitle">Login</div>
            <div class="mc">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="you@example.com" />
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password" />
                <button class="btn primary" id="loginSubmit">Login</button>
                <!--<hr/>
                <button class="btn primary" id="loginGithub">Login with GitHub</button>
                <button class="btn primary" id="loginGoogle">Login with Google</button>
                <button class="btn primary" id="loginMicrosoft">Login with Microsoft</button>-->
            </div>
            <div class="mf">
                <button class="btn" id="loginCancel">Cancel</button>
            </div>
        </div>
    </div>
    <div class="modal-backdrop" id="inviteBackdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="inviteTitle">
            <div class="mh" id="inviteTitle">Invite to list</div>
            <div class="mc">
                <div id="inviteDesc" style="color:var(--muted); font-size:14px;"></div>
                <label style="font-size:13px; color:var(--muted);">Emails (comma or newline separated)</label>
                <textarea id="inviteEmails" rows="4" placeholder="name@example.com, user2@example.com"></textarea>
                <div class="err" id="inviteErr">Please enter at least one valid email.</div>
            </div>
            <div class="mf">
                <button class="btn" id="inviteCancel">Cancel</button>
                <button class="btn primary" id="inviteSend">Send invites</button>
            </div>
        </div>
    </div>

    <script>
        const el = (s, d = document) => d.querySelector(s); const ce = (t, p = {}) => Object.assign(document.createElement(t), p);
        function softGradient(seed) { const rnd = mulberry32(Math.floor(seed * 1e9)); const h = rnd() * 360; const s = 35 + rnd() * 15; const l1 = 88 + rnd() * 6; const l2 = 72 + rnd() * 8; return { c1: `hsl(${h} ${s}% ${l1}%)`, c2: `hsl(${h + 20} ${s + 5}% ${l2}%)` } }; function mulberry32(a) { return function () { var t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296 } }

        const LISTS_KEY = 'tasks-lists-v1';
        const OLD_KEY = 'tasks-v2';
        const NOTES_KEY = 'notes-lists-v1';
        const MODE_KEY = 'mode-v1'; // 'tasks' | 'notes'

        function loadLists() {
            const raw = localStorage.getItem(LISTS_KEY);
            if (raw) return JSON.parse(raw);
            // migrate from old single-list storage if present
            const old = JSON.parse(localStorage.getItem(OLD_KEY) || 'null');
            const defaultTasks = Array.isArray(old) ? old : [{ title: 'Daily Water', desc: '', tags: ['health', 'wellness'], done: false, id: crypto.randomUUID(), grad: softGradient(Math.random()) }];
            const lists = { activeList: 'Default', lists: { 'Default': defaultTasks } };
            localStorage.setItem(LISTS_KEY, JSON.stringify(lists));
            if (old) localStorage.removeItem(OLD_KEY);
            return lists;
        }

        function loadNotes() {
            const raw = localStorage.getItem(NOTES_KEY);
            if (raw) return JSON.parse(raw);
            const notes = { activeList: 'Default', lists: { 'Default': [] } };
            localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
            return notes;
        }

        function saveLists(lists) {
            localStorage.setItem(LISTS_KEY, JSON.stringify(lists));
        }

        function saveNotes(notes) {
            localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
        }

        let listsState = loadLists();
        let notesState = loadNotes();
        let appMode = localStorage.getItem(MODE_KEY) || 'tasks';

        function getActiveListName() { return appMode === 'tasks' ? listsState.activeList : notesState.activeList; }
        function getActiveTasks() { return appMode === 'tasks' ? (listsState.lists[getActiveListName()] || []) : []; }
        function getActiveNotes() { return appMode === 'notes' ? (notesState.lists[getActiveListName()] || []) : []; }
        function setActiveList(name) {
            if (appMode === 'tasks') { listsState.activeList = name; saveLists(listsState); }
            else { notesState.activeList = name; saveNotes(notesState); }
            render(); renderListSelector();
        }
        function ensureList(name) {
            if (appMode === 'tasks') { if (!listsState.lists[name]) { listsState.lists[name] = []; saveLists(listsState); } }
            else { if (!notesState.lists[name]) { notesState.lists[name] = []; saveNotes(notesState); } }
        }

        function renderListSelector() {
            const select = document.getElementById('listSelect');
            const addBtn = document.getElementById('listAdd');
            if (!select || !addBtn) return;
            // populate options
            select.innerHTML = '';
            const src = appMode === 'tasks' ? listsState.lists : notesState.lists;
            Object.keys(src).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name; opt.textContent = name;
                const active = appMode === 'tasks' ? listsState.activeList : notesState.activeList;
                if (name === active) opt.selected = true;
                select.appendChild(opt);
            });
            select.onchange = () => setActiveList(select.value);
            addBtn.onclick = () => {
                const name = prompt('New list name:');
                if (!name) return;
                const src = appMode === 'tasks' ? listsState.lists : notesState.lists;
                if (src[name]) { setActiveList(name); return; }
                src[name] = [];
                setActiveList(name);
                if (appMode === 'tasks') saveLists(listsState); else saveNotes(notesState);
                renderListSelector();
            };
        }

        function save() { saveLists(listsState) }

        window.filter = null;

        const list = el('#list');
        function updateURLForList(name) {
            const url = new URL(window.location.href);
            if (name && name !== 'Default') { url.searchParams.set('cat', name); }
            else { url.searchParams.delete('cat'); }
            history.replaceState(null, '', url);
            // toggle share button visibility
            const shareBtn = document.getElementById('shareBtn');
            if (shareBtn) shareBtn.style.display = (name && name !== 'Default' && appMode == 'tasks') ? '' : 'none';
        }
        function render() {
            // build category chips (lists)
            const catsRow = document.getElementById('catsRow');
            const tagsRow = document.getElementById('tagsRow');
            if (catsRow) {
                catsRow.innerHTML = '';
                const src = appMode === 'tasks' ? listsState.lists : notesState.lists;
                Object.keys(src).filter(n => n !== 'Default').sort().forEach(name => {
                    const isActive = name === getActiveListName();
                    const chip = chipEl('@', name, isActive, () => { if (isActive) setActiveList('Default'); else setActiveList(name); });
                    const del = createChipDelete(() => tryDeleteCategory(name));
                    chip.appendChild(del);
                    catsRow.append(chip);
                });
            }
            if (tagsRow) {
                tagsRow.innerHTML = '';
            if (window.filter && appMode === 'tasks') {
                    const activeChip = chipEl('#', window.filter[1], true, () => { window.filter = null; render(); });
                    tagsRow.append(activeChip);
            } else if (appMode === 'tasks') {
                    const tags = [...new Set(getActiveTasks().flatMap(t => t.tags || []))].sort();
                    tags.forEach(tg => {
                        const chip = chipEl('#', tg, false, () => { window.filter = ['tag', tg]; render(); });
                        const del = createChipDelete(() => tryDeleteTag(tg));
                        chip.appendChild(del);
                        tagsRow.append(chip);
                    });
            } else if (appMode === 'notes') {
                    if (window.filter) {
                        const activeChip = chipEl('#', window.filter[1], true, () => { window.filter = null; render(); });
                        tagsRow.append(activeChip);
                    } else {
                        const tags = [...new Set(getActiveNotes().flatMap(n => n.tags || []))].sort();
                        tags.forEach(tg => {
                            const chip = chipEl('#', tg, false, () => { window.filter = ['tag', tg]; render(); });
                            const del = createChipDelete(() => tryDeleteTag(tg));
                            chip.appendChild(del);
                            tagsRow.append(chip);
                        });
                    }
                }
            }

            list.innerHTML = '';
            const titleEl = document.querySelector('header h1');
            if (titleEl) titleEl.textContent = appMode === 'tasks' ? 'Tasks' : 'Notes';

            if (appMode === 'tasks') {
                // inline add card at top
                list.classList.remove('notes-grid');
                list.appendChild(newTaskCard());
                const tasks = getActiveTasks();
                let shown = tasks;
                if (window.filter) { const [type, val] = window.filter; shown = tasks.filter(t => (t.tags || []).includes(val)); }
                shown = [...shown.filter(t => !t.done), ...shown.filter(t => t.done)];
                shown.forEach((t, i) => list.appendChild(taskCard(t, i)));
            } else {
                // Notes
                list.classList.add('notes-grid');
                list.appendChild(newNoteCard());
                let notes = getActiveNotes();
                if (window.filter) { const [type, val] = window.filter; notes = notes.filter(n => (n.tags || []).includes(val)); }
                notes.forEach((n, i) => list.appendChild(noteCard(n, i)));
            }
            updateURLForList(getActiveListName());

            // Toggle visibility of actions button
            const actionsBtn = document.getElementById('actionsBtn');
            if (actionsBtn) {
                actionsBtn.style.display = (appMode === 'tasks') ? '' : 'none';
            }

            // Update action buttons state
            const itemComplete = document.getElementById('actCompleteAll');
            const itemDelete = document.getElementById('actDeleteCompleted');
            const tasks = getActiveTasks();
            const hasAny = tasks.length > 0;
            const hasCompleted = tasks.some(t => t.done);
            if (itemComplete) {
                const allDone = hasAny && tasks.every(t => t.done);
                itemComplete.classList.toggle('disabled', appMode !== 'tasks' || !hasAny || allDone);
            }
            if (itemDelete) itemDelete.classList.toggle('disabled', appMode !== 'tasks' || !hasCompleted);
        }

        function chipEl(prefix, text, active, onX) {
            const c = ce('span', { className: 'chip' + (active ? ' active' : ''), title: (active ? 'Clear ' : 'Filter by ') + prefix + text });
            const label = ce('span', { textContent: prefix + text });
            c.append(label);
            if (active) { const x = ce('span', { className: 'x', textContent: '×' }); x.onclick = onX; c.append(x); } else { c.onclick = onX; }
            return c;
        }

        function parseInput(text) {
            const tags = [...text.matchAll(/#(\w+)/g)].map(m => m[1]);
            const catMatch = text.match(/@(\w+)/);
            const category = catMatch ? catMatch[1] : '';
            const title = text.replace(/#\w+/g, '').replace(/@\w+/, '').trim();
            return { title, tags, category };
        };

        function taskCard(task, index) {
            const card = ce('article', { className: 'card enter' + (task.done ? ' done' : '') });
            card.style.zIndex = String(index + 1);
            card.style.zIndex = String(1000 - index);
            card.style.animationDelay = (index * 40) + 'ms';
            if (!task.grad) task.grad = softGradient(Math.random());
            card.style.setProperty('--c1', task.grad.c1);
            card.style.setProperty('--c2', task.grad.c2);
            card.style.background = `linear-gradient(135deg, ${task.grad.c1}, ${task.grad.c2})`;

            card.ondblclick = () => { card.classList.add('solving'); setTimeout(() => { task.done = !task.done; save(); render(); }, 180) };

            // Touch events for mobile
            card.addEventListener('touchstart', () => card.classList.add('touch-active'));
            card.addEventListener('touchend', () => setTimeout(() => card.classList.remove('touch-active'), 300));
            card.addEventListener('touchcancel', () => card.classList.remove('touch-active'));

            // Swipe left to delete
            let touchStartX = 0;
            card.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });
            card.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].screenX;
                if (touchStartX - touchEndX > 80) { // swipe left threshold
                    if (confirm('Delete this task?')) {
                        const name = getActiveListName();
                        const tasks = listsState.lists[name] || [];
                        listsState.lists[name] = tasks.filter(t => t.id !== task.id);
                        save();
                        render();
                    }
                }
            });

            const rowx = ce('div', { className: 'rowx' });
            const title = ce('h2', { className: 'title', textContent: task.title });
            const check = ce('div', { className: 'check' + (task.done ? ' done' : ''), innerHTML: task.done ? '✓' : '' });
            check.onclick = e => { e.stopPropagation(); check.classList.add('pulse'); card.classList.add('solving'); setTimeout(() => { task.done = !task.done; save(); render(); }, 180) };

            rowx.append(title, check); card.append(rowx);
            if (task.desc) { card.append(ce('p', { className: 'desc', textContent: task.desc })) }

            // Enable inline editing on click
            card.onclick = () => {
                const editCard = ce('article', { className: 'card enter' });
                editCard.style.setProperty('--c1', task.grad.c1);
                editCard.style.setProperty('--c2', task.grad.c2);
                editCard.style.background = `linear-gradient(135deg, ${task.grad.c1}, ${task.grad.c2})`;

                const rowx = ce('div', { className: 'rowx' });
                const titleInput = ce('input', {
                    className: 'title-input',
                    value: task.title,
                    autocomplete: 'off'
                });
                const check = ce('div', { className: 'check', innerHTML: '✓' });

                function submitEdit() {
                    const v = (titleInput.value || '').trim();
                    if (!v) { render(); return; }
                    task.title = v;
                    task.desc = (descInput.value || '').trim();
                    save();
                    render();
                }

                check.onclick = (e) => { e.stopPropagation(); submitEdit(); };
                titleInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); submitEdit(); }
                    if (e.key === 'Escape') { e.preventDefault(); render(); }
                });

                rowx.append(titleInput, check);
                editCard.append(rowx);

                const descInput = ce('textarea', { className: 'desc-input', value: task.desc || '', placeholder: 'Optional description' });
                editCard.append(descInput);

                card.replaceWith(editCard);
                titleInput.focus();
            };

            if ((task.tags && task.tags.length) || (task.category && task.category !== 'Default')) {
                const tagsDiv = ce('div', { className: 'tags' });
                if (task.category && task.category !== 'Default') {
                    const span = ce('span', { textContent: '@' + task.category });
                    span.onclick = (e) => { e.stopPropagation(); setActiveList(task.category); };
                    tagsDiv.append(span);
                }
                (task.tags || []).forEach(tag => { const span = ce('span', { textContent: '#' + tag }); span.onclick = (e) => { e.stopPropagation(); window.filter = ['tag', tag]; render(); }; tagsDiv.append(span); });
                card.append(tagsDiv);
            }
            return card;
        }

        function newNoteCard() {
            const card = ce('article', { className: 'note-card note-new' });
            const input = ce('textarea', { className: 'note-input', autofocus: true, placeholder: 'Add a note (supports #tags and @category, or use /task or /note)', rows: 3 });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const v = (input.value || '').trim();
                    if (!v) return;

                    if (v.startsWith('/task')) {
                        const taskText = v.replace('/task', '').trim();
                        if (!taskText) return;
                        const { title, tags, category } = parseInput(taskText);
                        const descVal = '';
                        const finalTags = Array.from(new Set([
                            ...tags,
                            ...(window.filter && window.filter[0] === 'tag' ? [window.filter[1]] : [])
                        ]));
                        const targetList = category || getActiveListName();
                        ensureList(targetList);
                        const tasksArr = listsState.lists[targetList];
                        const newTask = { title, desc: descVal, tags: finalTags, done: false, id: crypto.randomUUID(), grad: softGradient(Math.random()) };
                        if (targetList !== 'Default') newTask.category = targetList;
                        tasksArr.unshift(newTask);
                        listsState.lists[targetList] = tasksArr;
                        save();
                        setActiveList(targetList);
                        input.value = '';
                        render();
                        return;
                    }

                    if (v.startsWith('/note')) {
                        const noteText = v.replace('/note', '').trim();
                        if (!noteText) return;
                        const { title, tags, category } = parseInput(noteText);
                        const text = title;
                        const finalTags = Array.from(new Set([
                            ...tags,
                            ...(window.filter && window.filter[0] === 'tag' ? [window.filter[1]] : [])
                        ]));
                        const targetList = category || getActiveListName();
                        if (!notesState.lists[targetList]) notesState.lists[targetList] = [];
                        const color = genNoteColor();
                        const newNote = { text, tags: finalTags, id: crypto.randomUUID(), color };
                        notesState.lists[targetList].unshift(newNote);
                        saveNotes(notesState);
                        setActiveList(targetList);
                        input.value = '';
                        render();
                        return;
                    }

                    const { title, tags, category } = parseInput(v);
                    const text = title;
                    const finalTags = Array.from(new Set([
                        ...tags,
                        ...(window.filter && window.filter[0] === 'tag' ? [window.filter[1]] : [])
                    ]));
                    const targetList = category || getActiveListName();
                    if (!notesState.lists[targetList]) notesState.lists[targetList] = [];
                    const color = genNoteColor();
                    const newNote = { text, tags: finalTags, id: crypto.randomUUID(), color };
                    notesState.lists[targetList].unshift(newNote);
                    saveNotes(notesState);
                    setActiveList(targetList);
                    input.value = '';
                }
            });
            card.append(input);
            return card;
        }

        function noteCard(note, index) {
            const card = ce('article', { className: 'note-card' });
            card.style.background = note.color || '#fffad1';
            const p = ce('p', { className: 'text', textContent: note.text || '' });
            const tagsDiv = ce('div', { className: 'tags' });
            (note.tags || []).forEach(tag => { const span = ce('span', { textContent: '#' + tag }); span.onclick = (e) => { e.stopPropagation(); window.filter = ['tag', tag]; render(); }; tagsDiv.append(span); });
            const del = ce('span', { className: 'del', innerHTML: '×', title: 'Delete' });
            del.onclick = (e) => {
                e.stopPropagation();
                if (!confirm('Delete this note?')) return;
                const name = getActiveListName();
                const listArr = notesState.lists[name] || [];
                notesState.lists[name] = listArr.filter(n => n.id !== note.id);
                saveNotes(notesState);
                render();
            };
            card.append(p, del);
            if ((note.tags || []).length) card.append(tagsDiv);
            card.onclick = () => {
                // Inline editor like add form
                const input = ce('textarea', { className: 'note-input', value: note.text || '' });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        const v = (input.value || '').trim();
                        const parsed = parseInput(v);
                        note.text = parsed.title;
                        // merge tags from edit
                        const newTags = Array.from(new Set([...(note.tags||[]), ...parsed.tags]));
                        note.tags = newTags;
                        saveNotes(notesState);
                        render();
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        render();
                    }
                });
                // Replace content with editor
                card.innerHTML = '';
                card.append(input);
                input.focus();
            };
            card.oncontextmenu = (e) => {
                e.preventDefault();
                del.click();
            };
            return card;
        }

        function genNoteColor(){
            const colors = ['#fffad1','#ffdfe0','#e7ffdf','#dff3ff','#f2e6ff','#ffe9d6'];
            return colors[Math.floor(Math.random()*colors.length)];
        }

        function newTaskCard() {
            const card = ce('article', { className: 'card enter' });
            const grad = softGradient(Math.random());
            card.style.setProperty('--c1', grad.c1);
            card.style.setProperty('--c2', grad.c2);
            card.style.background = `linear-gradient(135deg, ${grad.c1}, ${grad.c2})`;

            const rowx = ce('div', { className: 'rowx' });
            const titleInput = ce('input', {
                className: 'title-input',
                placeholder: 'Add a new task with #tags and @category',
                autocomplete: 'off'
            });
            const check = ce('div', { className: 'check', innerHTML: '+' });

            function submit() {
                if (submit.submitting) return;
                submit.submitting = true;
                const v = (titleInput.value || '').trim();
                if (!v) return;

                if (v.startsWith('/task')) {
                    const taskText = v.replace('/task', '').trim();
                    if (!taskText) return;
                    const { title, tags, category } = parseInput(taskText);
                    const descVal = (descInput.value || '').trim();
                    const finalTags = Array.from(new Set([
                        ...tags,
                        ...(window.filter && window.filter[0] === 'tag' ? [window.filter[1]] : [])
                    ]));
                    const targetList = category || getActiveListName();
                    ensureList(targetList);
                    const tasksArr = listsState.lists[targetList];
                    const newTask = { title, desc: descVal, tags: finalTags, done: false, id: crypto.randomUUID(), grad: softGradient(Math.random()) };
                    if (targetList !== 'Default') newTask.category = targetList;
                    tasksArr.unshift(newTask);
                    listsState.lists[targetList] = tasksArr;
                    save();
                    setActiveList(targetList);
                    titleInput.value = '';
                    render();
                    setTimeout(() => { submit.submitting = false; }, 0);
                    return;
                }

                if (v.startsWith('/note')) {
                    const noteText = v.replace('/note', '').trim();
                    if (!noteText) return;
                    const { title, tags, category } = parseInput(noteText);
                    const text = title;
                    const finalTags = Array.from(new Set([
                        ...tags,
                        ...(window.filter && window.filter[0] === 'tag' ? [window.filter[1]] : [])
                    ]));
                    const targetList = category || getActiveListName();
                    if (!notesState.lists[targetList]) notesState.lists[targetList] = [];
                    const color = genNoteColor();
                    const newNote = { text, tags: finalTags, id: crypto.randomUUID(), color };
                    notesState.lists[targetList].unshift(newNote);
                    saveNotes(notesState);
                    setActiveList(targetList);
                    titleInput.value = '';
                    render();
                    setTimeout(() => { submit.submitting = false; }, 0);
                    return;
                }

                const { title, tags, category } = parseInput(v);
                const descVal = (descInput.value || '').trim();
                // Auto-apply active tag filter to new task
                const finalTags = Array.from(new Set([
                    ...tags,
                    ...(window.filter && window.filter[0] === 'tag' ? [window.filter[1]] : [])
                ]));
                const targetList = category || getActiveListName();
                ensureList(targetList);
                const tasksArr = listsState.lists[targetList];
                const newTask = { title, desc: descVal, tags: finalTags, done: false, id: crypto.randomUUID(), grad: softGradient(Math.random()) };
                if (targetList !== 'Default') newTask.category = targetList;
                tasksArr.unshift(newTask);
                listsState.lists[targetList] = tasksArr;
                save();
                setActiveList(targetList);
                titleInput.value = '';
                // reset guard after render in a microtask
                setTimeout(() => { submit.submitting = false; }, 0);
            }

            check.onclick = (e) => { e.stopPropagation(); submit(); };
            titleInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submit();
                }
            });

            // Handle paste of multiline text
            titleInput.addEventListener('paste', (e) => {
                const text = (e.clipboardData || window.clipboardData).getData('text');
                const original = (e.clipboardData || window.clipboardData).getData('text')?.toString();
                if (text && text.includes('\n')) {
                    e.preventDefault();
                    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                    if (lines.length > 1) {
                        if (confirm('Split pasted text into ' + lines.length + ' tasks?')) {
                            const targetList = getActiveListName();
                            ensureList(targetList);
                            const tasksArr = listsState.lists[targetList];
                            lines.forEach(line => {
                                const { title, tags, category } = parseInput(line);
                                const finalTags = Array.from(new Set([
                                    ...tags,
                                    ...(window.filter && window.filter[0] === 'tag' ? [window.filter[1]] : [])
                                ]));
                                const newTask = { title, desc: '', tags: finalTags, done: false, id: crypto.randomUUID(), grad: softGradient(Math.random()) };
                                if (targetList !== 'Default') newTask.category = targetList;
                                tasksArr.unshift(newTask);
                            });
                            listsState.lists[targetList] = tasksArr;
                            save();
                            render();
                            return;
                        } else {
                            titleInput.value = original;
                        }
                    }
                }
            });

            rowx.append(titleInput, check);
            card.append(rowx);

            const descInput = ce('textarea', { className: 'desc-input', placeholder: 'Optional description' });
            card.append(descInput);

            // Suggestions dropdown
            const suggest = ce('div', { className: 'suggest hidden' });
            card.append(suggest);

            function getAllTags() { return [...new Set(getActiveTasks().flatMap(t => t.tags || []))].sort(); }
            function getAllCats() { return Object.keys(listsState.lists).filter(n => n !== 'Default').sort(); }

            function findTokenAtCursor(value, cursor) {
                // Find the last @ or # before cursor that is part of a word token
                let start = -1, type = null;
                for (let i = cursor - 1; i >= 0; i--) {
                    const ch = value[i];
                    if (ch === '#' || ch === '@') { start = i; type = ch; break; }
                    if (!/\w/.test(ch)) break;
                }
                if (start === -1) return null;
                const prefix = value.slice(start + 1, cursor);
                if (!/^\w*$/.test(prefix)) return null;
                return { start, prefix, type };
            }

            function renderSuggestions() {
                const value = titleInput.value;
                const cursor = titleInput.selectionStart || value.length;
                const tok = findTokenAtCursor(value, cursor);
                if (!tok) { suggest.classList.add('hidden'); suggest.innerHTML = ''; return; }
                const pool = tok.type === '#' ? getAllTags() : getAllCats();
                let list = pool.filter(x => x.toLowerCase().startsWith(tok.prefix.toLowerCase()));
                if (list.length === 0) { suggest.classList.add('hidden'); suggest.innerHTML = ''; return; }
                list = list.slice(0, 8);
                suggest.innerHTML = '';
                list.forEach((item, idx) => {
                    const it = ce('div', { className: 'item' + (idx === 0 ? ' active' : ''), textContent: (tok.type === '#' ? '#' : '@') + item });
                    it.onclick = () => applySuggestion(item, tok.type);
                    suggest.append(it);
                });
                suggest.classList.remove('hidden');
            }

            function applySuggestion(text, type) {
                const value = titleInput.value;
                const cursor = titleInput.selectionStart || value.length;
                const tok = findTokenAtCursor(value, cursor);
                if (!tok) return;
                const before = value.slice(0, tok.start + 1); // include trigger
                const afterIdx = tok.start + 1 + tok.prefix.length;
                const after = value.slice(afterIdx);
                const inserted = text;
                const newVal = before + inserted + after + ' ';
                titleInput.value = newVal;
                const newPos = (before + inserted + ' ').length;
                titleInput.setSelectionRange(newPos, newPos);
                suggest.classList.add('hidden');
                suggest.innerHTML = '';
                titleInput.focus();
            }

            function moveActive(delta) {
                if (suggest.classList.contains('hidden')) return;
                const items = [...suggest.querySelectorAll('.item')];
                if (!items.length) return;
                let idx = items.findIndex(i => i.classList.contains('active'));
                idx = (idx + delta + items.length) % items.length;
                items.forEach(i => i.classList.remove('active'));
                items[idx].classList.add('active');
            }

            function selectActive() {
                if (suggest.classList.contains('hidden')) return false;
                const elActive = suggest.querySelector('.item.active');
                if (!elActive) return false;
                const text = elActive.textContent || '';
                const type = text.startsWith('@') ? '@' : '#';
                applySuggestion(text.slice(1), type);
                return true;
            }

            titleInput.addEventListener('input', renderSuggestions);
            titleInput.addEventListener('click', renderSuggestions);
            titleInput.addEventListener('keyup', (e) => {
                if (['ArrowUp','ArrowDown','Enter','Escape','Tab'].includes(e.key)) return; // handled in keydown
                renderSuggestions();
            });
            titleInput.addEventListener('keydown', (e) => {
                if (!suggest.classList.contains('hidden')) {
                    if (e.key === 'ArrowDown') { e.preventDefault(); moveActive(1); return; }
                    if (e.key === 'ArrowUp') { e.preventDefault(); moveActive(-1); return; }
                    if (e.key === 'Enter' || e.key === 'Tab') {
                        if (selectActive()) { e.preventDefault(); return; }
                    }
                    if (e.key === 'Escape') { suggest.classList.add('hidden'); suggest.innerHTML=''; return; }
                }
                if (e.key === 'Enter' && suggest.classList.contains('hidden')) {
                    e.preventDefault(); submit();
                }
            });

            // focus title when rendered
            setTimeout(() => titleInput.focus(), 0);
            return card;
        }

        // Theme init
        (function initTheme(){
            const KEY = 'theme-v1';
            const stored = localStorage.getItem(KEY);
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = stored || (prefersDark ? 'dark' : 'light');
            function apply(t){
                document.documentElement.setAttribute('data-theme', t === 'dark' ? 'dark' : 'light');
                const icon = document.getElementById('themeIcon');
                if (icon) icon.innerHTML = t === 'dark'
                    ? '<circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/>'
                    : '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
            }
            apply(theme);

            // Update PWA status bar color
            const themeMeta = document.getElementById('themeColorMeta');
            if (themeMeta) {
                themeMeta.setAttribute('content', theme === 'dark' ? '#0f1216' : '#f6f8fb');
            }
            const btn = document.getElementById('themeBtn');
            if (btn) btn.addEventListener('click', () => {
                const next = (document.documentElement.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
                localStorage.setItem(KEY, next);
                apply(next);
                // Update PWA status bar color on toggle
                const themeMeta = document.getElementById('themeColorMeta');
                if (themeMeta) {
                    themeMeta.setAttribute('content', next === 'dark' ? '#0f1216' : '#f6f8fb');
                }
            });
            registerBackdrop && registerBackdrop.addEventListener('click', (e)=>{ if(e.target===registerBackdrop) closeModal(registerBackdrop); });
            loginBackdrop && loginBackdrop.addEventListener('click', (e)=>{ if(e.target===loginBackdrop) closeModal(loginBackdrop); });

            function closeModal(backdrop) {
                if (!backdrop) return;
                backdrop.classList.remove('show');
                backdrop.setAttribute('aria-hidden','true');
            }

            const registerSubmit = document.getElementById('registerSubmit');
            const loginSubmit = document.getElementById('loginSubmit');
            registerSubmit && registerSubmit.addEventListener('click', ()=>{
                const email = document.getElementById('registerEmail').value;
                const pass = document.getElementById('registerPassword').value;
                if(!email || !pass) { showToast('Please enter email and password', 'error'); return; }
                import('./auth.js').then(({ register }) => {
                    const passConfirm = document.getElementById('registerPasswordConfirm').value;
                    if (pass !== passConfirm) { showToast('Passwords do not match', 'error'); return; }
                    register(email, pass, passConfirm).then(user => {
                        showToast('Registered: ' + user.email, 'success');
                        closeModal(registerBackdrop);
                    }).catch(err => showToast('Registration failed: ' + err.message, 'error'));
                });
            });
            loginSubmit && loginSubmit.addEventListener('click', ()=>{
                const email = document.getElementById('loginEmail').value;
                const pass = document.getElementById('loginPassword').value;
                if(!email || !pass) { showToast('Please enter email and password', 'error'); return; }
                import('./auth.js').then(({ login }) => {
                    login(email, pass).then(authData => {
                        const email = authData.record.email;
                        const username = email.split('@')[0];
                        document.getElementById('username').textContent = username;
                        document.getElementById('menuSignOut').style.display = 'flex';
                        document.getElementById('menuRegister').style.display = 'none';
                        document.getElementById('menuLogin').style.display = 'none';
                        localStorage.setItem('pb_auth', JSON.stringify(authData));
                        showToast('Logged in as: ' + username, 'success');
                        closeModal(loginBackdrop);
                    }).catch(err => alert('Login failed: ' + err.message));
                });
            });
        })();

        // Mode init (Tasks / Notes)
        (function initMode(){
            const btn = document.getElementById('modeBtn');
            const icon = document.getElementById('modeIcon');
            function applyIcon(){
                if (!icon) return;
                icon.innerHTML = appMode === 'tasks'
                    ? '<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>'
                    : '<path d="M3 7h18"/><path d="M3 12h18"/><path d="M3 17h12"/>';
            }
            applyIcon();
            if (btn) btn.addEventListener('click', () => {
                appMode = appMode === 'tasks' ? 'notes' : 'tasks';
                localStorage.setItem(MODE_KEY, appMode);
                applyIcon();
                renderListSelector();
                render();
            });
        })();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(() => {});
            });
        }

        // Restore session if available
        (async function restoreSession(){
            const raw = localStorage.getItem('pb_auth');
            if(!raw) return;
            try {
                const authData = JSON.parse(raw);
                if(authData && authData.token && authData.record){
                    const { getPb } = await import('./auth.js');
                    // not loading sometimes
                    const pb = getPb();
                    if(!pb){ console.error("PocketBase client not initialized"); return; }
                    pb.authStore.save(authData.token, authData.record);
                    // verify with backend
                    try {
                        await pb.collection('users').authRefresh();
                        localStorage.setItem('pb_auth', JSON.stringify({
                            token: pb.authStore.token,
                            record: pb.authStore.model
                        }));
                    } catch(err){
                        console.warn("Session refresh failed", err);
                        pb.authStore.clear();
                        localStorage.removeItem('pb_auth');
                        return;
                    }
                    if(pb.authStore.isValid && pb.authStore.model){
                        const email = pb.authStore.model.email;
                        const username = email.split('@')[0];
                        document.getElementById('username').textContent = username;
                        document.getElementById('menuSignOut').style.display = 'flex';
                        document.getElementById('menuRegister').style.display = 'none';
                        document.getElementById('menuLogin').style.display = 'none';
                    }
                }
            } catch(e){
                console.error("Failed to restore session", e);
                //localStorage.removeItem('pb_auth');
            }
        })();

        // Initialize from URL param
        (function initFromURL(){
            const url = new URL(window.location.href);
            const cat = url.searchParams.get('cat');
            if (cat) { ensureList(cat); listsState.activeList = cat; saveLists(listsState); }
        })();
        // Render including inline add card and list selector
        renderListSelector();
        render();

        // Share/Invite behavior
        (function setupShare(){
            const shareBtn = document.getElementById('shareBtn');
            if (!shareBtn) return;
            const backdrop = document.getElementById('inviteBackdrop');
            const title = document.getElementById('inviteTitle');
            const desc = document.getElementById('inviteDesc');
            const emails = document.getElementById('inviteEmails');
            const err = document.getElementById('inviteErr');
            const cancelBtn = document.getElementById('inviteCancel');
            const sendBtn = document.getElementById('inviteSend');
            const actionsBtn = document.getElementById('actionsBtn');
            const actionsMenu = document.getElementById('actionsMenu');
            const actComplete = document.getElementById('actCompleteAll');
            const actDelete = document.getElementById('actDeleteCompleted');

            function openModal(){
                const cat = getActiveListName();
                title.textContent = 'Invite to @' + cat;
                desc.textContent = 'Enter email addresses to invite to this list. You will implement sending later.';
                emails.value = '';
                err.style.display = 'none';
                backdrop.classList.add('show');
                backdrop.setAttribute('aria-hidden','false');
                setTimeout(() => emails.focus(), 0);
            }
            function closeModal(){
                backdrop.classList.remove('show');
                backdrop.setAttribute('aria-hidden','true');
            }
            function toggleActions(){ if (actionsMenu.classList.contains('hidden')) { actionsMenu.classList.remove('hidden'); actionsBtn.setAttribute('aria-expanded','true'); } else { actionsMenu.classList.add('hidden'); actionsBtn.setAttribute('aria-expanded','false'); } }
            function closeActions(){ actionsMenu.classList.add('hidden'); actionsBtn.setAttribute('aria-expanded','false'); }
            function parseEmails(text){
                const parts = text.split(/[\,\n\s]+/).map(s => s.trim()).filter(Boolean);
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return Array.from(new Set(parts.filter(p => re.test(p.toLowerCase()))));
            }
            function saveInvites(cat, list){
                const KEY = 'invites-v1';
                const raw = localStorage.getItem(KEY);
                const data = raw ? JSON.parse(raw) : {};
                const prev = Array.isArray(data[cat]) ? data[cat] : [];
                const merged = Array.from(new Set([...prev, ...list]));
                data[cat] = merged;
                localStorage.setItem(KEY, JSON.stringify(data));
            }

            shareBtn.addEventListener('click', () => {
                const cat = getActiveListName();
                if (!cat || cat === 'Default') { showToast('Select a category to share.', 'error'); return; }
                openModal();
            });
            actionsBtn && actionsBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleActions(); });
            actComplete && actComplete.addEventListener('click', () => {
                if (actComplete.classList.contains('disabled')) return;
                const name = getActiveListName();
                const tasks = listsState.lists[name] || [];
                tasks.forEach(t => { t.done = true; });
                listsState.lists[name] = tasks;
                save();
                closeActions();
                render();
            });
            actDelete && actDelete.addEventListener('click', () => {
                if (actDelete.classList.contains('disabled')) return;
                const name = getActiveListName();
                const tasks = listsState.lists[name] || [];
                const hasCompleted = tasks.some(t => t.done);
                if (!hasCompleted) return;
                if (!confirm('Delete all completed tasks in @' + name + '?')) return;
                const kept = tasks.filter(t => !t.done);
                listsState.lists[name] = kept;
                save();
                closeActions();
                render();
            });
            backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeModal(); closeActions(); } });
            document.addEventListener('click', () => closeActions());
            cancelBtn.addEventListener('click', closeModal);
            sendBtn.addEventListener('click', () => {
                const list = parseEmails(emails.value);
                if (!list.length) { err.style.display = 'block'; emails.focus(); return; }
                const cat = getActiveListName();
                saveInvites(cat, list);
                closeModal();
                showToast('Invites prepared for @' + cat + ': ' + list.join(', '), 'info');
            });
            // initial visibility
            shareBtn.style.display = (appMode === 'tasks' && getActiveListName() !== 'Default') ? '' : 'none';
        })();

        // Account menu behavior
        (function setupAccountMenu(){
            const btn = document.getElementById('accountBtn');
            const menu = document.getElementById('accountMenu');
            if (!btn || !menu) return;
            function openMenu(){ menu.classList.remove('hidden'); btn.setAttribute('aria-expanded','true'); }
            function closeMenu(){ menu.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); }
            function toggleMenu(){ if (menu.classList.contains('hidden')) openMenu(); else closeMenu(); }
            btn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });
            document.addEventListener('click', ()=> closeMenu());
            document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeMenu(); });
            // Demo handlers
            const profile = document.getElementById('menuProfile');
            const settings = document.getElementById('menuSettings');
            const signout = document.getElementById('menuSignOut');
            profile && profile.addEventListener('click', ()=>{ closeMenu(); showToast('Profile clicked', 'info'); });
            settings && settings.addEventListener('click', ()=>{ closeMenu(); showToast('Settings clicked', 'info'); });
            signout && signout.addEventListener('click', ()=>{ 
                import('./auth.js').then(({ logout }) => {
                    logout();
                    document.getElementById('username').textContent = '';
                    document.getElementById('menuSignOut').style.display = 'none';
                    document.getElementById('menuRegister').style.display = 'flex';
                    document.getElementById('menuLogin').style.display = 'flex';
                    localStorage.removeItem('pb_auth');
                    showToast('Signed out', 'info');
                    closeMenu();
                });
            });

            const register = document.getElementById('menuRegister');
            const login = document.getElementById('menuLogin');
            const signoutBtn = document.getElementById('menuSignOut');
            if (signoutBtn) signoutBtn.style.display = 'none';
            const registerBackdrop = document.getElementById('registerBackdrop');
            const loginBackdrop = document.getElementById('loginBackdrop');
            const registerCancel = document.getElementById('registerCancel');
            const loginCancel = document.getElementById('loginCancel');

            function openModal(backdrop){ backdrop.classList.add('show'); backdrop.setAttribute('aria-hidden','false'); }
            function closeModal(backdrop){ backdrop.classList.remove('show'); backdrop.setAttribute('aria-hidden','true'); }

            register && register.addEventListener('click', ()=>{ closeMenu(); openModal(registerBackdrop); });
            login && login.addEventListener('click', ()=>{ closeMenu(); openModal(loginBackdrop); });
            registerCancel && registerCancel.addEventListener('click', ()=> closeModal(registerBackdrop));
            loginCancel && loginCancel.addEventListener('click', ()=> closeModal(loginBackdrop));
            registerBackdrop && registerBackdrop.addEventListener('click', (e)=>{ if(e.target===registerBackdrop) closeModal(registerBackdrop); });
            loginBackdrop && loginBackdrop.addEventListener('click', (e)=>{ if(e.target===loginBackdrop) closeModal(loginBackdrop); });
        })();

        // Chip delete control and deletion actions
        function createChipDelete(onClick) {
            const del = document.createElement('span');
            del.className = 'del';
            del.title = 'Delete';
            del.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>';
            del.addEventListener('click', (e) => { e.stopPropagation(); onClick(); });
            return del;
        }

        function tryDeleteCategory(name) {
            if (!name || name === 'Default') return;
            if (!confirm('Delete category @' + name + ' and move its tasks to Default?')) return;
            if (appMode === 'tasks') {
                const tasks = listsState.lists[name] || [];
                ensureList('Default');
                listsState.lists['Default'] = [...tasks, ...(listsState.lists['Default'] || [])];
                delete listsState.lists[name];
                setActiveList('Default');
                save();
            } else {
                const notes = notesState.lists[name] || [];
                if (!notesState.lists['Default']) notesState.lists['Default'] = [];
                notesState.lists['Default'] = [...notes, ...(notesState.lists['Default'] || [])];
                delete notesState.lists[name];
                setActiveList('Default');
                saveNotes(notesState);
            }
            renderListSelector();
            render();
        }

        function tryDeleteTag(tag) {
            if (!tag) return;
            if (!confirm('Remove #' + tag + ' from all items in this category?')) return;
            const name = getActiveListName();
            if (appMode === 'tasks') {
                const tasks = (listsState.lists[name] || []).map(t => ({
                    ...t,
                    tags: (t.tags || []).filter(x => x !== tag)
                }));
                listsState.lists[name] = tasks;
                save();
            } else {
                const notes = (notesState.lists[name] || []).map(n => ({
                    ...n,
                    tags: (n.tags || []).filter(x => x !== tag)
                }));
                notesState.lists[name] = notes;
                saveNotes(notesState);
            }
            render();
        }
    </script>
</body>

</html>
